name: Python Package CI/CD 

on: 
  push: 
    branches: [ "main" ] 
    tags: 
      - 'v*' # Trigger on tags starting with v 
  pull_request: 
    branches: [ "main" ] 

jobs: 
  test: 
    name: Test on Python ${{ matrix.python-version }} 
    runs-on: ubuntu-latest 
    strategy: 
      fail-fast: false 
      matrix: 
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"] 

    steps: 
    - name: Checkout repository 
      uses: actions/checkout@v4 

    - name: Set up Python ${{ matrix.python-version }} 
      uses: actions/setup-python@v5 
      with: 
        python-version: ${{ matrix.python-version }} 
        cache: 'pip' # Cache pip dependencies 

    - name: Install dependencies 
      run: | 
        python -m pip install --upgrade pip 
        pip install -e .[dev] 

    - name: Lint with ruff 
      uses: astral-sh/ruff-action@v1 
      with: 
        args: "check ." 

    - name: Format with ruff 
      uses: astral-sh/ruff-action@v1 
      with: 
        args: "format --check ." 

  publish: 
    name: Publish to PyPI 
    # This job only runs when a new tag starting with 'v' is pushed 
    if: startsWith(github.ref, 'refs/tags/v') 
    runs-on: ubuntu-latest 

    permissions: 
      # This permission is required for trusted publishing 
      id-token: write 

    steps: 
    - name: Checkout repository 
      uses: actions/checkout@v4 

    - name: Set up Python 
      uses: actions/setup-python@v5 
      with: 
        python-version: '3.12' 

    - name: Install build tools 
      run: python -m pip install build 

    - name: Build package 
      run: python -m build 

    - name: Publish package to PyPI 
      uses: pypa/gh-action-pypi-publish@release/v1 